trigger:
  branches:
    include:
      - main
  paths:
    include:
      - 'terraform/**'

pool:
  vmImage: ubuntu-latest

variables:
  - group: terraform-variables

steps:
- checkout: self

- task: DownloadSecureFile@1
  name: envFile
  displayName: 'Download .env'
  inputs:
    secureFile: '.env'

- script: |
    echo "Current directory: $(pwd)"
    echo "Repository contents:"
    ls -la
    echo "Terraform directory contents:"
    ls -la terraform/

    set -a
    source $(envFile.secureFilePath)
    set +a

    cd terraform

    echo "Installing Terraform..."
    wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
    echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
    sudo apt update && sudo apt install terraform

    echo "Running Terraform init..."
    terraform init \
      -backend-config="resource_group_name=bestrong-tfstate-rg" \
      -backend-config="storage_account_name=bestrongtfstate" \
      -backend-config="container_name=tfstate" \
      -backend-config="key=terraform.tfstate"

    echo "Running Terraform plan..."
    terraform plan -out=tfplan

    echo "Running Terraform apply..."
    terraform apply -auto-approve tfplan
  displayName: 'Deploy Terraform Infrastructure'
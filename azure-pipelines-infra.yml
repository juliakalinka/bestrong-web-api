trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - "*"

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: workingDirectory
    value: '$(System.DefaultWorkingDirectory)'
  - group: terraform-variables

stages:
  - stage: Deploy
    jobs:
      - job: Terraform
        steps:
          - checkout: self

          - task: DownloadSecureFile@1
            name: envFile
            displayName: 'Download .env File'
            inputs:
              secureFile: '.env'

          - task: Bash@3
            displayName: 'Install Terraform via APT'
            inputs:
              targetType: 'inline'
              script: |
                sudo apt-get update -y
                sudo apt-get install -y gnupg software-properties-common curl
                curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
                echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
                sudo apt-get update -y
                sudo apt-get install -y terraform
                terraform -version

          - task: Bash@3
            displayName: 'Terraform Init, Plan and Apply'
            inputs:
              targetType: 'inline'
              script: |
                echo "Converting .env to Unix format..."
                tr -d '\r' < "$(envFile.secureFilePath)" > clean.env
                source clean.env
                set -e

                echo "Initializing Terraform..."
                terraform -chdir=$(workingDirectory) init \
                  -backend-config="storage_account_name=$TF_STATE_SA" \
                  -backend-config="container_name=$TF_STATE_CONTAINER" \
                  -backend-config="resource_group_name=$TF_STATE_RG"

                echo "Planning Terraform..."
                terraform -chdir=$(workingDirectory) plan -out=tfplan

                echo "Applying Terraform..."
                terraform -chdir=$(workingDirectory) apply -auto-approve tfplan
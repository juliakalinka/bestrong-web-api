trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerRegistryServiceConnection: 'DockerHub'
  imageRepository: 'yuliakalinka/bestrong-web-api'
  dockerfile: 'Dockerfile'
  tag: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: 'Build and Test'
  jobs:
  - job: Build
    displayName: 'Build and Test'
    steps:
    - checkout: self
      
    - task: Docker@2
      displayName: 'Build Docker image'
      inputs:
        command: build
        repository: $(imageRepository)
        dockerfile: $(dockerfile)
        buildContext: $(Build.SourcesDirectory)
        tags: |
          $(tag)
          latest

    - task: Docker@2
      displayName: 'Push Docker image'
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
      inputs:
        dockerRegistryServiceConnection: 'docker-hub-connection'
        repository: $(imageRepository)
        command: push
        tags: |
          $(tag)
          latest

- stage: Deploy
  displayName: 'Deploy to Azure'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: DeployWebApp
    displayName: 'Deploy to Azure Web App'
    steps:
    - task: DownloadSecureFile@1
      name: envFile
      displayName: 'Download .env file'
      inputs:
        secureFile: '.env'
        
    - task: AzureWebAppContainer@1
      displayName: 'Deploy to Azure Web App'
      inputs:
        azureSubscription: 'bestrong-azure-connection'
        appName: 'bestrong-web-app'
        containers: '$(imageRepository):$(tag)'
        multicontainerConfigFile: ''
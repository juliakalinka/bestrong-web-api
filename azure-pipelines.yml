trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  - group: terraform-web-vars
  - name: ACR_NAME
    value: 'bestrongacr1web'
  - name: IMAGE_NAME
    value: 'bestrong-web-api'
  - name: DOCKERFILE_PATH
    value: 'Dockerfile'

stages:
  - stage: BuildAndPush
    displayName: Build and Push Docker image
    jobs:
      - job: DockerJob
        displayName: Build & Push
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
          
          - script: |
              echo "Перевірка структури репозиторію"
              ls -la
            displayName: 'Виведення структури репозиторію'

          - task: DownloadSecureFile@1
            name: envFile
            displayName: 'Download .env file'
            inputs:
              secureFile: '.env'

          - script: |
              echo "Loading environment variables from .env file..."
              set -a
              source $(envFile.secureFilePath)
              set +a
            displayName: 'Load environment variables'

          - task: AzureCLI@2
            displayName: 'Build and Push Docker Image to ACR'
            inputs:
              azureSubscription: 'AzureConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Logging into ACR..."
                az acr login --name $(ACR_NAME)
                
                echo "Building Docker image..."
                docker build -t $(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId) -t $(ACR_NAME).azurecr.io/$(IMAGE_NAME):latest -f $(DOCKERFILE_PATH) .
                
                echo "Pushing Docker image..."
                docker push $(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId)
                docker push $(ACR_NAME).azurecr.io/$(IMAGE_NAME):latest

  - stage: DeployToAzure
    displayName: 'Deploy to Azure App Service'
    dependsOn: BuildAndPush
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployWebApp
        displayName: 'Deploy to Azure Web App'
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: AzureWebAppContainer@1
            displayName: 'Deploy to Azure Web App'
            inputs:
              azureSubscription: 'AzureConnection'
              appName: 'bestrong-web-app'
              imageName: '$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(Build.BuildId)'